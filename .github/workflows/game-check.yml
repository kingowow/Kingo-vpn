name: Game VPN - Collect URLs (No Test)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */5 * * *'   # every 5 hours
  workflow_dispatch:

jobs:
  collect-vpn:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        persist-credentials: false

    - name: Fetch and normalize configs
      run: |
        set +e

        mkdir -p game
        > game/active_urls.txt
        > /tmp/urls.txt

        while read -r src; do
          [[ -z "$src" || "$src" =~ ^# ]] && continue
          echo "Source: $src"

          data=$(curl -fsSL "$src" || true)

          # Plain URLs
          echo "$data" | \
            grep -E '^(ss|vmess|vless|trojan)://' >> /tmp/urls.txt || true

          # Base64 URLs
          echo "$data" | \
            base64 -d 2>/dev/null | \
            grep -E '^(ss|vmess|vless|trojan)://' >> /tmp/urls.txt || true

        done < scripts/sources.txt

        sort -u /tmp/urls.txt | while read -r line; do
          clean=$(echo "$line" | cut -d'#' -f1)
          echo "${clean}#@kingo_team" >> game/active_urls.txt
        done

    - name: Commit and push
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/kingowow/Kingo-vpn.git

        git add game/active_urls.txt
        git diff --cached --quiet || \
          (git commit -m "Update game VPN configs (no test)" && git push origin main)