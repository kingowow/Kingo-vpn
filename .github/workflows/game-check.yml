name: Game VPN - Collect URLs (No Test)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

jobs:
  collect-vpn:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        persist-credentials: false

    - name: Fetch and normalize configs (Telegram + Others)
      run: |
        set +e

        mkdir -p game
        > game/active_urls.txt
        > /tmp/urls.txt

        # ==================================================
        # 1) Telegram sources (HTML -> plain text -> extract)
        # ==================================================
        while read -r src; do
          [[ -z "$src" || "$src" =~ ^# ]] && continue
          [[ "$src" != tg:* ]] && continue

          channel="${src#tg:}"
          tg_url="https://t.me/s/${channel}"

          echo "Telegram source: $channel"

          curl -s "$tg_url" | \
            sed 's/<br>/\n/g' | \
            sed 's/<[^>]*>//g' | \
            grep -oE '(ss|vmess|vless|trojan)://[^\s]+' | \
            head -n 50 >> /tmp/urls.txt || true

        done < scripts/sources.txt

        # ==================================================
        # 2) Other sources (plain text or base64 subscriptions)
        # ==================================================
        while read -r src; do
          [[ -z "$src" || "$src" =~ ^# ]] && continue
          [[ "$src" == tg:* ]] && continue

          echo "Source: $src"
          data=$(curl -fsSL "$src" || true)

          # Plain (one config per line)
          echo "$data" | \
            grep -E '^(ss|vmess|vless|trojan)://' >> /tmp/urls.txt || true

          # Base64 subscription
          echo "$data" | \
            base64 -d 2>/dev/null | \
            grep -E '^(ss|vmess|vless|trojan)://' >> /tmp/urls.txt || true

        done < scripts/sources.txt

        # ==================================================
        # 3) Normalize output (keep full params, rename tag)
        # ==================================================
        sort -u /tmp/urls.txt | while read -r line; do
          clean=$(echo "$line" | cut -d'#' -f1)
          echo "${clean}#@kingo_team" >> game/active_urls.txt
        done

    - name: Commit and push
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/kingowow/Kingo-vpn.git

        git add game/active_urls.txt
        git diff --cached --quiet || \
          (git commit -m "Update game VPN configs (telegram + no test)" && git push origin main)